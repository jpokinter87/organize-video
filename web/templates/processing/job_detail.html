{% extends "base.html" %}

{% block title %}Job #{{ job.id }} - Video Organizer{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'processing:job_list' %}" class="text-dark-400 hover:text-white mb-4 inline-flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Retour aux jobs
        </a>
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white">Job #{{ job.id }}</h1>
                <p class="text-dark-400 mt-1">Cree le {{ job.created_at|date:"d/m/Y" }} a {{ job.created_at|time:"H:i" }}</p>
            </div>
            <span class="px-4 py-2 rounded-lg text-sm font-medium
                {% if job.status == 'completed' %}bg-green-500/20 text-green-400
                {% elif job.status == 'failed' %}bg-red-500/20 text-red-400
                {% elif job.status == 'processing' or job.status == 'scanning' %}bg-blue-500/20 text-blue-400
                {% elif job.status == 'awaiting_confirmation' %}bg-yellow-500/20 text-yellow-400
                {% else %}bg-dark-600 text-dark-300{% endif %}">
                {{ job.get_status_display }}
            </span>
        </div>
    </div>

    <!-- Progress (if running) -->
    {% if job.status in 'pending,scanning,processing,awaiting_confirmation' %}
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6 mb-6"
         hx-get="{% url 'processing:job_detail' job.id %}"
         hx-trigger="every 3s"
         hx-select="#job-progress"
         hx-swap="outerHTML"
         id="job-progress">
        <div class="flex items-center justify-between mb-2">
            <span class="text-white font-medium">Progression</span>
            {% if job.progress_total %}
            <span class="text-dark-400">{{ job.progress_processed }}/{{ job.progress_total }}</span>
            {% endif %}
        </div>
        <div class="w-full bg-dark-700 rounded-full h-3">
            <div class="bg-primary-500 h-3 rounded-full transition-all duration-500"
                 style="width: {% if job.progress_total %}{% widthratio job.progress_processed job.progress_total 100 %}{% else %}0{% endif %}%"></div>
        </div>
        {% if job.current_file %}
        <p class="text-sm text-dark-400 mt-2 truncate">{{ job.current_file }}</p>
        {% endif %}

        {% if job.status != 'completed' and job.status != 'failed' %}
        <div class="mt-4">
            <a href="{% url 'processing:job_cancel' job.id %}"
               class="text-red-400 hover:text-red-300 text-sm">
                Annuler ce job
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Job Details -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Configuration</h3>
            <dl class="space-y-3">
                <div class="flex justify-between">
                    <dt class="text-dark-400">Repertoire</dt>
                    <dd class="text-white">{{ job.source_directory|default:"Par defaut" }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-dark-400">Categories</dt>
                    <dd class="text-white">{{ job.categories|join:", "|default:"Toutes" }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-dark-400">Periode</dt>
                    <dd class="text-white">{% if job.process_all %}Tous les fichiers{% else %}{{ job.days_back }} jours{% endif %}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-dark-400">Mode simulation</dt>
                    <dd class="text-white">{% if job.dry_run %}Oui{% else %}Non{% endif %}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-dark-400">Mode force</dt>
                    <dd class="text-white">{% if job.force_mode %}Oui{% else %}Non{% endif %}</dd>
                </div>
            </dl>
        </div>

        <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Resultats</h3>
            <dl class="space-y-3">
                <div class="flex justify-between">
                    <dt class="text-dark-400">Videos traitees</dt>
                    <dd class="text-white">{{ job.progress_processed|default:0 }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-dark-400">Confirmees</dt>
                    <dd class="text-green-400">{{ job.progress_confirmed|default:0 }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-dark-400">Echouees</dt>
                    <dd class="text-red-400">{{ job.progress_failed|default:0 }}</dd>
                </div>
                {% if job.started_at %}
                <div class="flex justify-between">
                    <dt class="text-dark-400">Debut</dt>
                    <dd class="text-white">{{ job.started_at|time:"H:i:s" }}</dd>
                </div>
                {% endif %}
                {% if job.completed_at %}
                <div class="flex justify-between">
                    <dt class="text-dark-400">Fin</dt>
                    <dd class="text-white">{{ job.completed_at|time:"H:i:s" }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>
    </div>

    <!-- Pending Confirmations -->
    {% if confirmations %}
    <div class="bg-dark-800 rounded-lg border border-dark-700 mb-6">
        <div class="px-6 py-4 border-b border-dark-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white">Confirmations en attente</h3>
            <span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-sm">{{ confirmations.count }}</span>
        </div>
        <div class="divide-y divide-dark-700">
            {% for conf in confirmations|slice:":5" %}
            <div class="px-6 py-3 flex items-center justify-between">
                <span class="text-white truncate">{{ conf.video.detected_title|default:conf.video.original_filename }}</span>
                <a href="{% url 'processing:confirmations' %}"
                   class="text-primary-500 hover:text-primary-400 text-sm">
                    Resoudre
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Logs -->
    <div class="bg-dark-800 rounded-lg border border-dark-700">
        <div class="px-6 py-4 border-b border-dark-700">
            <h3 class="text-lg font-semibold text-white">Logs recents</h3>
        </div>
        <div class="max-h-96 overflow-y-auto">
            {% for log in logs %}
            <div class="px-6 py-3 border-b border-dark-700/50 flex items-start gap-3">
                <span class="flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium
                    {% if log.level == 'error' %}bg-red-500/20 text-red-400
                    {% elif log.level == 'warning' %}bg-yellow-500/20 text-yellow-400
                    {% elif log.level == 'success' %}bg-green-500/20 text-green-400
                    {% else %}bg-dark-600 text-dark-300{% endif %}">
                    {{ log.level }}
                </span>
                <div class="flex-1 min-w-0">
                    <p class="text-white text-sm">{{ log.message }}</p>
                    <p class="text-dark-500 text-xs mt-1">{{ log.created_at|time:"H:i:s" }}</p>
                </div>
            </div>
            {% empty %}
            <div class="px-6 py-8 text-center text-dark-400">
                Aucun log
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
